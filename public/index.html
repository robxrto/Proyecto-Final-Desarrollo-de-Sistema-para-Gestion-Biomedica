<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Hospitalario - Dashboard</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Estilos adicionales para el dashboard */
        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .dashboard-header h1 {
            color: #1a2980;
            margin-bottom: 10px;
        }
        
        .dashboard-header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .user-info {
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(26, 41, 128, 0.2);
        }
        
        .user-info .welcome {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .user-info .role {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        
        .menu-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #eaeaea;
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .menu-card h2 {
            color: #1a2980;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.5rem;
        }
        
        .menu-btn {
            display: block;
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            background: #f8f9fa;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .menu-btn:hover {
            background: #1a2980;
            color: white;
            border-color: #1a2980;
            transform: translateX(5px);
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-left: 4px solid #1a2980;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1a2980;
            margin: 10px 0;
            transition: color 0.3s ease;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .card-description {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            display: none;
            border-left: 4px solid #dc3545;
        }
        
        .loading {
            color: #6c757d;
            font-style: italic;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            display: none;
            border-left: 4px solid #28a745;
        }
        
        .refresh-btn {
            background: #26d0ce;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #1a8c8a;
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stats-header h2 {
            color: #1a2980;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .stats-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>
    
    <div class="container">
        <div class="dashboard-header">
            <h1>üè• Sistema de Gesti√≥n Hospitalaria</h1>
            <p>Panel de control - Administraci√≥n integral de pacientes, medicamentos y dispositivos</p>
        </div>
        
        <div id="user-info-container" class="user-info" style="display: none;">
            <!-- Se llena din√°micamente con JavaScript -->
        </div>
        
        <!-- Mensajes de estado -->
        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>
        
        <!-- Estad√≠sticas r√°pidas -->
        <div id="quick-stats-container">
            <div class="stats-header">
                <h2>üìä Estad√≠sticas R√°pidas</h2>
                <button id="refresh-stats-btn" class="refresh-btn" title="Actualizar estad√≠sticas">
                    üîÑ Actualizar
                </button>
            </div>
            <div id="quick-stats" class="quick-stats">
                <div class="stat-card">
                    <div class="number" id="stat-pacientes">0</div>
                    <div class="label">Pacientes registrados</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-medicamentos">0</div>
                    <div class="label">Medicamentos en inventario</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-dispositivos">0</div>
                    <div class="label">Dispositivos disponibles</div>
                </div>
            </div>
        </div>
        
        <div class="menu-grid">
            <div class="menu-card">
                <h2>üë• Pacientes</h2>
                <p class="card-description">Gestiona la informaci√≥n de los pacientes registrados en el sistema</p>
                <a href="/ver-pacientes" class="menu-btn">üìã Ver Pacientes</a>
                <a href="/agregar-paciente" class="menu-btn" id="btn-agregar-paciente">‚ûï Agregar Paciente</a>
                <a href="/eliminar-paciente" class="menu-btn" id="btn-eliminar-paciente">üóëÔ∏è Eliminar Paciente</a>
            </div>
            
            <div class="menu-card">
                <h2>üíä Medicamentos</h2>
                <p class="card-description">Administra el inventario de medicamentos y sus funciones</p>
                <a href="/ver-medicamentos" class="menu-btn">üìã Ver Medicamentos</a>
                <a href="/agregar-medicamento" class="menu-btn" id="btn-agregar-medicamento">‚ûï Agregar Medicamento</a>
                <a href="/eliminar-medicamento" class="menu-btn" id="btn-eliminar-medicamento">üóëÔ∏è Eliminar Medicamento</a>
            </div>
            
            <div class="menu-card">
                <h2>ü©∫ Dispositivos M√©dicos</h2>
                <p class="card-description">Controla el estado y disponibilidad de equipos m√©dicos</p>
                <a href="/ver-dispositivos" class="menu-btn">üìã Ver Dispositivos</a>
                <a href="/agregar-dispositivo" class="menu-btn" id="btn-agregar-dispositivo">‚ûï Agregar Dispositivo</a>
                <a href="/eliminar-dispositivo" class="menu-btn" id="btn-eliminar-dispositivo">üóëÔ∏è Eliminar Dispositivo</a>
            </div>
            
            <div class="menu-card">
                <h2>üìÅ Archivos</h2>
                <p class="card-description">Sube y descarga documentos, reportes y archivos del sistema</p>
                <a href="/subir-archivo" class="menu-btn" id="btn-subir-archivo">‚¨ÜÔ∏è Subir Archivos</a>
                <a href="/descargar-archivos" class="menu-btn" id="btn-descargar-archivos">‚¨áÔ∏è Descargar Archivos</a>
            </div>
            
            <!-- NUEVA TARJETA: Descargar Excel -->
            <div class="menu-card" id="excel-card">
                <h2>üìä Descargar Excel</h2>
                <p class="card-description">Genera reportes en formato Excel de pacientes, medicamentos y dispositivos</p>
                <a href="/descargar-excel" class="menu-btn" id="btn-descargar-excel">üì• Descargar Reportes Excel</a>
                <a href="/descargar-excel-pacientes" class="menu-btn" id="btn-excel-pacientes">üë• Excel de Pacientes</a>
                <a href="/descargar-excel-medicamentos" class="menu-btn" id="btn-excel-medicamentos">üíä Excel de Medicamentos</a>
                <a href="/descargar-excel-dispositivos" class="menu-btn" id="btn-excel-dispositivos">ü©∫ Excel de Dispositivos</a>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 50px; padding-top: 30px; border-top: 1px solid #eaeaea;">
            <p style="color: #888; font-size: 0.9rem;">
                Sistema Hospitalario v1.0 ‚Ä¢ 
                <span id="current-date"></span> ‚Ä¢ 
                <span id="user-type"></span> ‚Ä¢
                <span id="last-update">√öltima actualizaci√≥n: <span id="update-time">--:--:--</span></span>
            </p>
        </div>
    </div>

    <script>
        // Variables globales
        let userTipo = '';
        let userName = '';
        let refreshInterval;
        
        // Funci√≥n para mostrar mensaje de error
        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = mensaje;
            errorDiv.style.display = 'block';
            
            // Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
            
            console.error('Error:', mensaje);
        }
        
        // Funci√≥n para mostrar mensaje de √©xito
        function mostrarExito(mensaje) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = mensaje;
            successDiv.style.display = 'block';
            
            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }
        
        // Funci√≥n para actualizar la hora de √∫ltima actualizaci√≥n
        function actualizarHoraActualizacion() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            document.getElementById('update-time').textContent = timeString;
        }
        
        // Funci√≥n para cargar estad√≠sticas r√°pidas DESDE EL SERVIDOR
        async function cargarEstadisticas() {
            console.log('üìä Cargando estad√≠sticas...');
            
            try {
                // Mostrar estado de carga
                document.getElementById('stat-pacientes').textContent = '...';
                document.getElementById('stat-medicamentos').textContent = '...';
                document.getElementById('stat-dispositivos').textContent = '...';
                
                // Cargar contador de pacientes
                const pacientesRes = await fetch('/api/contar-pacientes');
                if (!pacientesRes.ok) {
                    throw new Error(`Error ${pacientesRes.status} al cargar pacientes`);
                }
                const pacientesData = await pacientesRes.json();
                document.getElementById('stat-pacientes').textContent = pacientesData.total;
                console.log(`‚úÖ Pacientes: ${pacientesData.total}`);
                
                // Cargar contador de medicamentos
                const medicamentosRes = await fetch('/api/contar-medicamentos');
                if (!medicamentosRes.ok) {
                    throw new Error(`Error ${medicamentosRes.status} al cargar medicamentos`);
                }
                const medicamentosData = await medicamentosRes.json();
                document.getElementById('stat-medicamentos').textContent = medicamentosData.total;
                console.log(`‚úÖ Medicamentos: ${medicamentosData.total}`);
                
                // Cargar contador de dispositivos
                const dispositivosRes = await fetch('/api/contar-dispositivos');
                if (!dispositivosRes.ok) {
                    throw new Error(`Error ${dispositivosRes.status} al cargar dispositivos`);
                }
                const dispositivosData = await dispositivosRes.json();
                document.getElementById('stat-dispositivos').textContent = dispositivosData.total;
                console.log(`‚úÖ Dispositivos disponibles: ${dispositivosData.total}`);
                
                // Actualizar hora de √∫ltima actualizaci√≥n
                actualizarHoraActualizacion();
                
                // Mostrar mensaje de √©xito
                mostrarExito('‚úÖ Estad√≠sticas actualizadas correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas:', error);
                mostrarError(`Error al cargar estad√≠sticas: ${error.message}`);
                
                // Mostrar valores de error
                document.getElementById('stat-pacientes').textContent = 'Error';
                document.getElementById('stat-medicamentos').textContent = 'Error';
                document.getElementById('stat-dispositivos').textContent = 'Error';
                
                // Reintentar en 10 segundos
                setTimeout(cargarEstadisticas, 10000);
            }
        }
        
        // Funci√≥n para cargar informaci√≥n del usuario
        async function cargarInformacionUsuario() {
            try {
                const response = await fetch('/tipo-usuario');
                if (!response.ok) {
                    throw new Error('No autenticado');
                }
                
                const data = await response.json();
                userTipo = data.tipo_usuario;
                console.log('‚úÖ Usuario tipo:', userTipo);
                
                // Obtener nombre de usuario si est√° disponible
                try {
                    const userResponse = await fetch('/api/usuario-actual');
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        userName = userData.nombre_usuario;
                    } else {
                        userName = 'Usuario';
                    }
                } catch {
                    userName = 'Usuario';
                }
                
                // Mostrar informaci√≥n del usuario
                const userInfoContainer = document.getElementById('user-info-container');
                
                let roleText = '';
                switch(userTipo) {
                    case 'medico':
                        roleText = 'üë®‚Äç‚öïÔ∏è M√©dico';
                        break;
                    case 'enfermero':
                        roleText = 'üë©‚Äç‚öïÔ∏è Enfermero/a';
                        break;
                    case 'paciente':
                        roleText = 'üë§ Paciente';
                        break;
                    default:
                        roleText = userTipo;
                }
                
                userInfoContainer.innerHTML = `
                    <div class="welcome">Bienvenido, <strong>${userName}</strong></div>
                    <div class="role">${roleText}</div>
                `;
                userInfoContainer.style.display = 'flex';
                
                // Actualizar permisos seg√∫n tipo de usuario
                actualizarPermisos(userTipo);
                
                // Actualizar informaci√≥n de pie de p√°gina
                document.getElementById('user-type').textContent = roleText;
                
                // Configurar fecha actual
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                document.getElementById('current-date').textContent = 
                    now.toLocaleDateString('es-ES', options);
                
            } catch (error) {
                console.error('‚ùå Error cargando informaci√≥n del usuario:', error);
                if (error.message === 'No autenticado') {
                    window.location.href = '/login';
                } else {
                    mostrarError('Error al cargar informaci√≥n del usuario');
                }
            }
        }
        
        // Funci√≥n para actualizar permisos seg√∫n tipo de usuario
        function actualizarPermisos(tipoUsuario) {
            console.log('üîê Actualizando permisos para:', tipoUsuario);
            
            // Obtener todos los botones
            const botones = {
                agregarPaciente: document.getElementById('btn-agregar-paciente'),
                eliminarPaciente: document.getElementById('btn-eliminar-paciente'),
                agregarMedicamento: document.getElementById('btn-agregar-medicamento'),
                eliminarMedicamento: document.getElementById('btn-eliminar-medicamento'),
                agregarDispositivo: document.getElementById('btn-agregar-dispositivo'),
                eliminarDispositivo: document.getElementById('btn-eliminar-dispositivo'),
                subirArchivo: document.getElementById('btn-subir-archivo'),
                descargarArchivos: document.getElementById('btn-descargar-archivos'),
                descargarExcel: document.getElementById('btn-descargar-excel'),
                excelPacientes: document.getElementById('btn-excel-pacientes'),
                excelMedicamentos: document.getElementById('btn-excel-medicamentos'),
                excelDispositivos: document.getElementById('btn-excel-dispositivos'),
                excelCard: document.getElementById('excel-card')
            };
            
            // Restablecer todos los botones
            Object.values(botones).forEach(btn => {
                if (btn) {
                    btn.style.display = 'block';
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                }
            });
            
            // Aplicar restricciones seg√∫n tipo de usuario
            switch(tipoUsuario) {
                case 'medico':
                    // M√©dico tiene acceso completo
                    console.log('‚úÖ Permisos completos (m√©dico)');
                    break;
                    
                case 'enfermero':
                    // Enfermero: no puede agregar medicamentos ni dispositivos
                    // PERO S√ç puede subir, descargar archivos y descargar Excel
                    console.log('‚úÖ Permisos de enfermero');
                    if (botones.agregarMedicamento) {
                        botones.agregarMedicamento.style.display = 'none';
                        console.log('‚ùå Ocultando agregar medicamento');
                    }
                    if (botones.eliminarMedicamento) {
                        botones.eliminarMedicamento.style.display = 'none';
                        console.log('‚ùå Ocultando eliminar medicamento');
                    }
                    if (botones.agregarDispositivo) {
                        botones.agregarDispositivo.style.display = 'none';
                        console.log('‚ùå Ocultando agregar dispositivo');
                    }
                    if (botones.eliminarDispositivo) {
                        botones.eliminarDispositivo.style.display = 'none';
                        console.log('‚ùå Ocultando eliminar dispositivo');
                    }
                    // Enfermeros S√ç pueden subir, descargar archivos y descargar Excel
                    console.log('‚úÖ Enfermeros pueden subir/descargar archivos y Excel');
                    break;
                    
                case 'paciente':
                    // Paciente: solo puede ver pacientes, no puede descargar Excel
                    console.log('‚úÖ Permisos de paciente (solo lectura)');
                    Object.values(botones).forEach(btn => {
                        if (btn && btn.id !== '') {
                            // Solo ocultar botones con ID (los de acci√≥n)
                            btn.style.display = 'none';
                            console.log(`‚ùå Ocultando ${btn.id}`);
                        }
                    });
                    // Ocultar toda la tarjeta de Excel para pacientes
                    if (botones.excelCard) {
                        botones.excelCard.style.display = 'none';
                        console.log('‚ùå Ocultando tarjeta de Excel para paciente');
                    }
                    // Permitir ver pacientes pero no las acciones
                    break;
                    
                default:
                    console.warn('‚ö†Ô∏è Tipo de usuario no reconocido:', tipoUsuario);
            }
        }
        
        // Manejar clics en botones para verificar permisos
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('menu-btn')) {
                const buttonId = e.target.id;
                const tipoUsuario = userTipo;
                
                // Verificar permisos seg√∫n el bot√≥n clickeado
                if (tipoUsuario === 'paciente') {
                    // Paciente solo puede ver pacientes
                    if (!buttonId && e.target.href.includes('/ver-pacientes')) {
                        return; // Permitir
                    }
                    if (buttonId || !e.target.href.includes('/ver-pacientes')) {
                        e.preventDefault();
                        mostrarError('No tienes permisos para realizar esta acci√≥n.');
                        return;
                    }
                }
                
                if (tipoUsuario === 'enfermero') {
                    // Enfermero no puede agregar medicamentos ni dispositivos
                    if (buttonId === 'btn-agregar-medicamento' || 
                        buttonId === 'btn-eliminar-medicamento' ||
                        buttonId === 'btn-agregar-dispositivo' ||
                        buttonId === 'btn-eliminar-dispositivo') {
                        e.preventDefault();
                        mostrarError('Solo los m√©dicos pueden realizar esta acci√≥n.');
                        return;
                    }
                    // Enfermero S√ç puede subir, descargar archivos y descargar Excel - no bloquear estos botones
                }
            }
        });
        
        // Inicializar la aplicaci√≥n cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando dashboard...');
            
            // 1. Cargar navbar
            fetch('/navbar')
                .then(response => {
                    if (!response.ok) {
                        console.error('‚ùå Error cargando navbar:', response.status);
                        return '';
                    }
                    return response.text();
                })
                .then(html => {
                    if (html) {
                        document.getElementById('navbar-container').innerHTML = html;
                        console.log('‚úÖ Navbar cargado');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error cargando navbar:', error);
                    mostrarError('Error al cargar la barra de navegaci√≥n');
                });
            
            // 2. Cargar informaci√≥n del usuario
            cargarInformacionUsuario();
            
            // 3. Cargar estad√≠sticas por primera vez
            setTimeout(() => {
                cargarEstadisticas();
            }, 1000); // Peque√±o delay para asegurar que el usuario est√© autenticado
            
            // 4. Configurar bot√≥n de actualizaci√≥n manual
            document.getElementById('refresh-stats-btn').addEventListener('click', function() {
                console.log('üîÑ Actualizando estad√≠sticas manualmente...');
                cargarEstadisticas();
            });
            
            // 5. Configurar actualizaci√≥n autom√°tica cada 30 segundos
            refreshInterval = setInterval(cargarEstadisticas, 30000);
            
            console.log('‚úÖ Dashboard inicializado correctamente');
        });
        
        // Limpiar intervalo cuando se cierre la p√°gina
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>